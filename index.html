<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Signature</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; text-align:center; padding:10px; }
  #pad { border:1px solid #333; width:100%; height:300px; touch-action:none; }
  button{ margin:8px; padding:10px 16px; font-size:16px; }
</style>
</head>
<body>
<h3>Signer ici</h3>
<canvas id="pad"></canvas>
<br/>
<button id="clear">Effacer</button>
<button id="send">Envoyer</button>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.expand(); // ouvre en grand si possible
}

const canvas = document.getElementById('pad');
function resizeCanvas(){
  const ratio = window.devicePixelRatio || 1;
  canvas.width = canvas.clientWidth * ratio;
  canvas.height = canvas.clientHeight * ratio;
  const ctx = canvas.getContext('2d');
  ctx.scale(ratio, ratio);
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const ctx = canvas.getContext('2d');
let drawing = false;

canvas.addEventListener('pointerdown', (e)=>{
  drawing = true;
  const rect = canvas.getBoundingClientRect();
  ctx.beginPath();
  ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
});
canvas.addEventListener('pointermove', (e)=>{
  if(!drawing) return;
  const rect = canvas.getBoundingClientRect();
  ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
  ctx.stroke();
});
canvas.addEventListener('pointerup', ()=> drawing = false);
canvas.addEventListener('pointercancel', ()=> drawing = false);

document.getElementById('clear').addEventListener('click', ()=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);
});

document.getElementById('send').addEventListener('click', ()=>{
  // Récupérer l'ID Telegram de l'utilisateur via Telegram WebApp
  let tgUser = {};
  try {
    // initDataUnsafe donne user si présent (attention : pas cryptographique)
    const unsafe = Telegram.WebApp.initDataUnsafe?.();
    if (unsafe && unsafe.user) tgUser = unsafe.user;
  } catch(e){ console.warn(e); }

  const imgData = canvas.toDataURL('image/png');

  // Envoi de la donnée au bot : ici on envoie un JSON encodé en string
  const payload = {
    telegram_id: tgUser.id || null,
    user: tgUser,
    image: imgData
  };

  // sendData envoie la string au bot (le bot recevra web_app_data)
  Telegram.WebApp.sendData(JSON.stringify(payload));

  // optionnel : fermer la webapp
  Telegram.WebApp.close();
});
</script>
</body>
</html>
